@page "/items"
@using SaveItForPantry.Data
@using SaveItForPantry.Services
@using MudBlazor
@using SaveItForPantry.Components.Items
@inject ItemService ItemService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using Microsoft.AspNetCore.Authorization

@attribute [Authorize]

<PageTitle>Product List</PageTitle>

<MudContainer Fixed="true" MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">Product List</MudText>

<div style="margin-bottom:1rem;">
    <MudAutocomplete T="ItemData" Label="Search" @bind-Value="selectedUpc" SearchFunc="@SearchUpcs"
                     ToStringFunc="@(u => u?.Title ?? u?.Upc ?? string.Empty)" PreserveText="true">
        <NotFoundContent>
            <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" @onclick="AddNewItem">Add New UPC</MudButton>
        </NotFoundContent>
    </MudAutocomplete>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" @onclick="ShowAddItemFlowDialog">Add UPC</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" @onclick="AddProduct">Add Product</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Info" Size="Size.Small" @onclick="ShowScanBarcodeDialog">Scan Barcode</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small" @onclick="LoadAllAsync">Clear</MudButton>
</div>

@if (items is null)
{
    <MudAlert Severity="Severity.Info">Loading . . . </MudAlert>
}
else if (items.Length == 0)
{
    <MudAlert Severity="Severity.Info">No Products Yet.</MudAlert>
    @if (!string.IsNullOrWhiteSpace(searchTerm))
    {
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" @onclick="ShowAddItemFlowDialog">Add UPC</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" @onclick="AddProduct">Add Product</MudButton>
    }
}
else
{

        <MudTable Items="items" Hover="true" Class="fill-height" Breakpoint="Breakpoint.Md">
        <HeaderContent>
            <MudTh>Image</MudTh>
            <MudTh>UPC</MudTh>
            <MudTh>Title</MudTh>
            <MudTh>Brand</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Image">
                <div class="thumbnail-container">
                    @if (!string.IsNullOrWhiteSpace(context.ImageUrl))
                    {
                        <img src="@context.ImageUrl" class="thumbnail" />
                        <img src="@context.ImageUrl" class="enlarged" />
                    }
                    else
                    {
                        <div class="thumbnail">No Image</div>
                    }
                </div>
            </MudTd>
            <MudTd DataLabel="UPC">@context.Upc</MudTd>
            <MudTd DataLabel="Title">@context.Title</MudTd>
            <MudTd DataLabel="Brand">@context.Brand</MudTd>
            <MudTd DataLabel="Actions">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="() => EditItem(context)">Edit</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Error" @onclick="() => RemoveItem(context)">Remove</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
}
</MudContainer>
@code {
    private ItemData[]? items;
    private ItemData? selectedUpc;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadAllAsync();
    }

    private async Task LoadAllAsync()
    {
        items = await ItemService.GetAllAsync();
        selectedUpc = null;
        searchTerm = "";
        StateHasChanged();
    }

    private async Task<IEnumerable<ItemData>> SearchUpcs(string value, CancellationToken token)
    {
        searchTerm = value;
        if (string.IsNullOrWhiteSpace(value))
        {
            return Enumerable.Empty<ItemData>();
        }
        return await ItemService.SearchLocalAsync(value);
    }

    private async void ShowScanBarcodeDialog()
    {
        var dialog = await DialogService.ShowAsync<ScanBarcodeDialog>("Scan Barcode");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var parameters = new DialogParameters { ["upcToSearch"] = result.Data.ToString() };
            var addDialog = await DialogService.ShowAsync<AddItemFlowDialog>("Add Item", parameters);
            var addResult = await addDialog.Result;

            if (!addResult.Canceled)
            {
                await LoadAllAsync();
            }
        }
    }

    private async void ShowAddItemFlowDialog()
    {
        var dialog = await DialogService.ShowAsync<AddItemFlowDialog>("Add Item");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadAllAsync();
        }
    }

    private async void AddNewItem()
    {
        var parameters = new DialogParameters { ["Upc"] = searchTerm };
        var dialog = await DialogService.ShowAsync<SearchApiAndAddItemDialog>("Add New Item", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadAllAsync();
        }
    }

    private void AddProduct()
    {
        NavigationManager.NavigateTo($"/upcs/new/0");
    }

    private async void EditItem(ItemData item)
    {
        var parameters = new DialogParameters { ["UpcData"] = item };
        var dialog = await DialogService.ShowAsync<EditItemDialog>("Edit Item", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadAllAsync();
        }
    }

    private async void RemoveItem(ItemData item)
    {
        var yesNo = await DialogService.ShowMessageBox(
            "Confirm Removal",
            "Are you sure you want to remove this Item?",
            yesText: "Remove", cancelText: "Cancel");

        if (yesNo == true)
        {
            await ItemService.DeleteAsync(item);
            await LoadAllAsync();
        }
    }
}