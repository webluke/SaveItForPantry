@page "/upcs"
@using SaveItForPantry.Data
@using SaveItForPantry.Services
@using MudBlazor
@inject UpcService UpcService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<h3>UPCs</h3>

<div style="margin-bottom:1rem;">
    <MudTextField @bind-Value="searchUpc" Label="Search UPC" Variant="Variant.Outlined" Margin="Margin.Dense"></MudTextField>
    <MudTextField @bind-Value="searchTitle" Label="Search Title" Variant="Variant.Outlined" Margin="Margin.Dense"></MudTextField>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="SearchAsync">Search</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Secondary" @onclick="LoadAllAsync">Clear</MudButton>
</div>

@if (items is null)
{
    <p>Loading...</p>
}
else if (items.Length == 0)
{
    <p>No UPCs found.</p>
}
else
{
    <MudTable Items="items" Hover="true" Breakpoint="Breakpoint.Sm">
        <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>UPC</MudTh>
            <MudTh>Title</MudTh>
            <MudTh>Brand</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="UPC">@context.Upc</MudTd>
            <MudTd DataLabel="Title">@context.Title</MudTd>
            <MudTd DataLabel="Brand">@context.Brand</MudTd>
            <MudTd DataLabel="Actions">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="() => NavigateToDetails(context.Id)">Details / Edit</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private UpcData[]? items;
    private string searchUpc = "";
    private string searchTitle = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadAllAsync();
    }

    private async Task LoadAllAsync()
    {
        items = await UpcService.GetAllAsync();
        searchUpc = "";
        searchTitle = "";
        StateHasChanged();
    }

    private async Task SearchAsync()
    {
        try
        {
            items = await UpcService.SearchWithLookupAsync(searchUpc, null);
        }
        catch (NoApiResultException ex)
        {
            Snackbar.Add(ex.Message, Severity.Info);
            NavigationManager.NavigateTo($"/upcs/new/{searchUpc}");
        }
        StateHasChanged();
    }


    private void NavigateToDetails(int id) => NavigationManager.NavigateTo($"/upcs/{id}");
}